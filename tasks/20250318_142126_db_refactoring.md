# Database Layer Refactoring

## Analysis

The current database implementation has several issues that need to be addressed:

1. **Monolithic Repository File**: The `repository.py` file is too large (1370 lines) containing all database operations for different entities.
2. **Direct Database Queries**: Many parts of the codebase bypass the repository pattern by directly using `execute_query` from either `src/db/connection.py` or the deprecated `src/utils/db.py`.
3. **Deprecated Utils**: There's still usage of `src/utils/db.py` which has been marked as deprecated in favor of `src/db` modules.
4. **Incomplete Documentation**: While `db_instructions.md` provides good documentation, it needs updating to reflect the new structure.

## Plan

### Phase 1: Create New Repository Structure ✅

1. Create a new subdirectory structure in `src/db/repository/` with separate files for each entity:
   - `src/db/repository/__init__.py` - exports all repository functions ✅
   - `src/db/repository/agent.py` - Agent repository functions ✅
   - `src/db/repository/user.py` - User repository functions ✅
   - `src/db/repository/session.py` - Session repository functions ✅
   - `src/db/repository/message.py` - Message repository functions ✅
   - `src/db/repository/memory.py` - Memory repository functions ✅

2. Move each set of repository functions from `repository.py` to their respective new files ✅

3. Update imports in each new repository file ✅

4. Update the main `__init__.py` in the repository directory to export all functions ✅

### Phase 2: Update Root Database Module ✅

1. Update `src/db/__init__.py` to import from the new repository structure ✅

2. Ensure backward compatibility by re-exporting all the same functions that were previously available ✅

### Phase 3: Find and Fix Direct Database Access ✅

1. Identify all code that directly uses:
   - `from src.utils.db import execute_query` ✅
   - `from src.db import execute_query` ✅
   - `from src.db.connection import execute_query` ✅

2. For each affected file:
   - Determine which repository function should be used instead ✅
   - Replace direct query usage with appropriate repository function ✅
   - If no suitable repository function exists, create one in the appropriate repository file ✅

3. Update scripts and utilities that use direct database access: ✅
   - scripts/tool_description_inspector.py ✅
   - scripts/direct_description_test.py ✅
   - scripts/view_memory_tools.py ✅
   - scripts/cleanup_memory_read_modes.py ✅ (partially - still using direct SQL for complex WHERE clauses)

### Phase 4: Update Documentation ✅

1. Update `db_instructions.md` to:
   - Explain the new repository structure ✅
   - Document all available repository functions ✅
   - Provide clear examples of how to use each repository ✅
   - Add guidelines for creating new repository functions ✅
   - Add guidelines for migrating from direct SQL to repository pattern ✅

## Execution

### Step 1: Set up the new repository directory structure ✅

```bash
mkdir -p src/db/repository
touch src/db/repository/__init__.py
touch src/db/repository/agent.py
touch src/db/repository/user.py
touch src/db/repository/session.py
touch src/db/repository/message.py
touch src/db/repository/memory.py
```

### Step 2: Migrate Repository Functions ✅

#### Agent Repository (agent.py) ✅

Extract all agent-related functions from `repository.py` to `src/db/repository/agent.py`:
- `get_agent`
- `get_agent_by_name`
- `list_agents`
- `create_agent`
- `update_agent`
- `delete_agent`
- `increment_agent_run_id`
- `link_session_to_agent`

#### User Repository (user.py) ✅

Extract all user-related functions to `src/db/repository/user.py`:
- `get_user`
- `get_user_by_email`
- `get_user_by_identifier`
- `list_users`
- `create_user`
- `update_user`
- `delete_user`

#### Session Repository (session.py) ✅

Extract all session-related functions to `src/db/repository/session.py`:
- `get_session`
- `get_session_by_name`
- `list_sessions`
- `create_session`
- `update_session`
- `delete_session`
- `finish_session`

#### Memory Repository (memory.py) ✅

Extract all memory-related functions to `src/db/repository/memory.py`:
- `get_memory`
- `get_memory_by_name`
- `list_memories`
- `create_memory`
- `update_memory`
- `delete_memory`

#### Message Repository (message.py) ✅

Extract all message-related functions to `src/db/repository/message.py`:
- `create_message`
- `get_message`
- `list_messages`
- `update_message`
- `delete_message`
- `get_system_prompt`
- `delete_session_messages`

### Step 3: Update Repository __init__.py ✅

Create a comprehensive `__init__.py` in the repository directory that exports all functions.

### Step 4: Update Root Module __init__.py ✅

Update `src/db/__init__.py` to import from the new repository structure.

### Step 5: Find and Fix Direct Database Access ✅

Files identified with direct database access:
- `src/main.py` ✅
- `src/memory/pg_message_store.py` ✅
- `src/agents/models/agent_db.py` ✅
- `src/agents/simple/sofia_agent/agent.py` ✅
- `src/api/routes.py` ✅
- `src/tools/memory_tools/update.py` ✅
- Various scripts in `scripts/` directory:
  - `scripts/cleanup_memory_read_modes.py` ✅
  - `scripts/view_memory_tools.py` ✅
  - `scripts/direct_description_test.py` ✅
  - `scripts/tool_description_inspector.py` ✅

### Step 6: Update Documentation ✅

Update `src/db/db_instructions.md` with:
- New repository structure explanation ✅
- All available repository functions ✅
- Clear examples for each entity type ✅
- Guidelines for creating new repository functions ✅
- Guidelines for migrating from direct SQL to repository pattern ✅

## Testing

For each phase:

1. Run existing tests to ensure everything still works ✅
2. Manually test database operations ✅
3. Check for any import errors or broken functionality ✅

## Comprehensive Plan to Eliminate All Direct SQL Queries ✅

After a thorough analysis of the codebase, we identified several files that contained direct SQL queries bypassing the repository pattern. Here's a detailed overview of how each file was updated:

### 1. Core Application Files ✅

#### 1.1. src/main.py ✅

**Status**: Updated.
- Now uses repository functions like `ensure_default_user_exists` and imports from `src.db`
- Test operations have been migrated from direct SQL to repository functions

#### 1.2. src/api/routes.py ✅

**Status**: Updated.
- The `delete_session_route` has been updated to use repository functions
- Other parts that used direct SQL queries have been migrated to repository functions

#### 1.3. src/memory/pg_message_store.py ✅

**Status**: Updated.
- All direct SQL queries replaced with repository function calls
- Code now follows the repository pattern consistently

### 2. Agent Files ✅

#### 2.1. src/agents/models/agent_db.py ✅

**Status**: Updated.
- Replaced direct SQL queries with repository function calls
- Now imports repository functions from `src.db`

#### 2.2. src/agents/simple/sofia_agent/agent.py ✅

**Status**: Updated.
- Replaced direct SQL queries in `_load_memory_values` and `_get_agent_id_numeric` methods
- Now uses `get_agent`, `get_agent_by_name`, and `list_memories` repository functions

### 3. Tool Files ✅

#### 3.1. src/tools/memory_tools/update.py ✅

**Status**: Updated.
- Replaced direct SQL queries with repository functions
- Imports `get_agent_by_name`, `get_memory`, and `update_memory_in_db` from `src.db`

### 4. Scripts Directory ✅

#### 4.1. scripts/view_memory_tools.py ✅

**Status**: Updated to use repository functions.

#### 4.2. scripts/direct_description_test.py ✅

**Status**: Updated to use repository functions.

#### 4.3. scripts/cleanup_memory_read_modes.py ✅

**Status**: Partially updated. Still using direct SQL for complex WHERE clauses that don't have suitable repository function equivalents. This is acceptable as these are specialized one-time scripts with complex queries.

#### 4.4. scripts/tool_description_inspector.py ✅

**Status**: Updated to use repository functions.

## Updated Task List

1. ✅ Create repository directory structure
2. ✅ Implement entity-specific repository files
3. ✅ Create repository entry point module
4. ✅ Update db_instructions.md
5. ✅ Implement new repository functions:
   - ✅ `ensure_default_user_exists` in user.py
   - ✅ `delete_session_messages` in message.py
6. ✅ Update core application files:
   - ✅ main.py
   - ✅ routes.py
   - ✅ pg_message_store.py
7. ✅ Update agent and tool files:
   - ✅ agent_db.py
   - ✅ sofia_agent/agent.py
   - ✅ memory_tools/update.py
8. ✅ Update scripts:
   - ✅ view_memory_tools.py
   - ✅ direct_description_test.py
   - ✅ cleanup_memory_read_modes.py
   - ✅ tool_description_inspector.py
9. ✅ Final verification and testing:
   - ✅ Run grep search for "execute_query"
   - ✅ Test all updated functionality
   - ✅ Document any exceptions

## Conclusion

The database layer refactoring has been successfully completed. The codebase now follows a clean repository pattern with separate files for each entity type. All direct SQL queries have been replaced with repository function calls, except for a few specialized cases in one-time scripts where complex WHERE clauses make it difficult to use standardized repository functions.

The documentation has been enhanced to provide guidance on migrating from direct SQL to the repository pattern, and all files have been updated to use the new structure. This refactoring will significantly improve code organization, maintainability, and testability, making it easier to add new database operations in the future.

### Final Issue Found and Fixed

During final verification, one remaining direct SQL query was found in the `register_tools` method of the `SofiaAgent` class in `src/agents/simple/sofia_agent/agent.py`. This method was using a direct SQL query to fetch memories for tool descriptions:

```python
# Direct database approach - fetch memories directly from DB
query = "SELECT id, name, description FROM memories ORDER BY name ASC"
result = execute_query(query)
```

This was replaced with the repository function `list_memories()`:

```python
# Use repository function to get all available memories
memories_objects = list_memories()
```

With this final fix, all application code now follows the repository pattern, making the codebase more maintainable and consistent. 