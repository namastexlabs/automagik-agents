---
description: 
globs: 
alwaysApply: false
---
# Dependency Management Rules

Proper dependency hygiene keeps builds reproducible and secure.

## 1. Authoritative Source of Truth

* We use **`pyproject.toml` + `uv.lock`** as the canonical record of all Python packages and versions.
* Never edit `uv.lock` by hand; it is generated automatically.

## 2. Adding a New Package

1. Activate your dev environment.
2. Run `uv pip install <package>[extras]==<version>` (pin to the latest stable unless a specific version is required).
3. Commit the updated `pyproject.toml` **and** the regenerated `uv.lock`.
4. Add the package to the relevant group if using `tool.poetry.group.*` conventions.

## 3. Updating Packages

Monthly dependency bumps are handled via Dependabot or the `make bump-deps` target which executes:
```bash
uv pip install -r pyproject.toml --upgrade
uv pip compile  # regenerates uv.lock
```

Review the changelog for *breaking changes* before merging.

## 4. Removing Packages

1. Remove import usages from code.  
2. Run `uv pip uninstall <package>`; commit the lockfile changes.

## 5. Security Scanning

CI runs `pip-audit` against `uv.lock`; any CVE with severity ≥ *medium* fails the build.

Developers can run locally:
```bash
pip-audit -r uv.lock
```

## 6. Vendoring / Forks

Occasionally we patch a library that's unmaintained.  In that case:
1. Fork the repo under the `automagik-dev` GitHub org.  
2. Publish it to PyPI under a new name (e.g. `somepkg-automagik`).  
3. Replace the old requirement with the new package in `pyproject.toml`.

## 7. Non-Python Dependencies

* Node tooling (`npm`, `pnpm`) should also pin versions in `package.json` + `pnpm-lock.yaml`.
* Docker images are referenced by *immutable* digests, not tags.

## 8. Local Editable Installs

Avoid `pip install -e .` in CI – builds must use the sdist/wheel path to mirror production.

## 9. Caching & Reproducibility

* CI caches the Poetry/uv directory to speed up installs.
* If the cache becomes corrupt, bump `CACHE_VERSION` in the workflow file.
